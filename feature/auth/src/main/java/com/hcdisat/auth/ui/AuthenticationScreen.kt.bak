package com.hcdisat.feature.auth.ui

import androidx.compose.runtime.Composable
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.ui.Modifier
import com.hcdisat.abstraction.networking.AccountSessionState
import com.hcdisat.common.settings.Constants.CLIENT_ID
import com.hcdisat.feature.auth.ui.components.AuthenticationContent
import com.hcdisat.ui.components.AppScaffold
import com.stevdzasan.messagebar.rememberMessageBarState
import com.stevdzasan.onetap.OneTapSignInWithGoogle
import com.stevdzasan.onetap.rememberOneTapSignInState
import kotlinx.coroutines.delay

@Composable
fun AuthenticationScreen(
    state: AuthenticationState,
    onEvent: (AuthenticationScreenEvent) -> Unit
) {
    val messageBarState = rememberMessageBarState()
    val oneTapState = rememberOneTapSignInState()

    val (sessionState, loadingState) = state

    AppScaffold(
        modifier = Modifier,
        messageBarState = messageBarState,
        topBar = {},
        content = {
            AuthenticationContent(
                loadingState = loadingState,
                onButtonClick = {
                    oneTapState.open()
                    onEvent(AuthenticationScreenEvent.UpdateLoading(true))
                }
            )
        }
    )

    OneTapSignInWithGoogle(
        state = oneTapState,
        clientId = CLIENT_ID,
        onTokenIdReceived = { token -> onEvent(AuthenticationScreenEvent.OnTokenReceived(token)) },
        onDialogDismissed = {
            messageBarState.addError(Exception(it))
            onEvent(AuthenticationScreenEvent.UpdateLoading(false))
        }
    )

    LaunchedEffect(key1 = sessionState) {
        when (sessionState) {
            is AccountSessionState.LoggedOut -> Unit

            AccountSessionState.LoggedIn -> {
                messageBarState.addSuccess("Successfully Authenticated!")
                delay(600)
                onEvent(AuthenticationScreenEvent.OnLoginSuccess)
            }

            is AccountSessionState.Error -> {
                messageBarState.addError(Exception("Something went wrong please try again"))
            }
        }
    }
}

sealed interface AuthenticationScreenEvent {
    data class UpdateLoading(val isLoading: Boolean) : AuthenticationScreenEvent
    data class OnTokenReceived(val token: String) : AuthenticationScreenEvent
    data object OnLoginSuccess : AuthenticationScreenEvent
}